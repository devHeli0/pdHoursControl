# Use a slim Node.js base image
FROM node:20-slim AS build

# Set environment variable for pnpm home directory
ENV PNPM_HOME="/pnpm"

# Add pnpm to PATH (optional, consider using `pnpm config set add-path` as discussed earlier)
RUN corepack enable

# Copy project files to the container
WORKDIR /backdev
COPY package*.json pnpm-lock.yaml ./
COPY ./src/Infrastructure/prisma ./prisma/
COPY . .

# Install dependencies and build the application in one stage
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile && pnpm build

# Final stage with a smaller image size
FROM build AS final
COPY --from=build /backdev/dist /backdev/dist
EXPOSE 3000
CMD [ "pnpm", "start:prod" ]
